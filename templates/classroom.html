{% extends "base.html" %}

{% block title %}TwoToro - {{ roomName }}{% endblock %}

{% block extra_styles %}
  {{ super() }}
  <style>
    body {
      background-color: #f8f9fa;
    }

    .video-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      padding: 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
    }

    video {
      width: 100%;
      background-color: #000;
      border-radius: 8px;
      border: 2px solid #ccc;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    }

    .status-messages {
      max-height: 150px;
      overflow-y: auto;
    }

    .whiteboard-container {
      max-width: 900px;
      margin: 30px auto;
      border: 2px solid #ddd;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .toolbar button {
      margin: 0 10px;
    }

    .hidden { display: none; }

    #startSessionBtn {
      margin: 1rem auto;
      display: block;
    }

    @media (max-width: 480px) {
      .video-container, .whiteboard-container {
        padding: 10px;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container py-4">

  <!-- Start Session Button -->
  <button id="startSessionBtn" class="btn btn-success">Start Session</button>

  <!-- Control Panel -->
  <div class="d-flex justify-content-center align-items-center gap-3 my-4 bg-white shadow p-3 rounded">
    <div id="reconnectBanner" class="hidden bg-success-subtle rounded px-3 py-2">üîÅ Reconnected successfully</div>

    <span class="badge bg-secondary" id="sessionTimer">Session Time: 00:00</span>

    <button id="shareScreenBtn" class="btn btn-primary">Share Screen</button>

    <button id="flipRemoteBtn" class="btn btn-secondary">
      {% if role=='tutor' %} Flip Student Video
      {% elif role=='student' %} Flip Teacher Video
      {% else %} Flip Remote Video
      {% endif %}
    </button>

    <button id="exitBtn" class="btn btn-danger" onclick="window.location.href='{{ url_for('dashboard') }}'">
      <i class="fas fa-sign-out-alt"></i> Exit Classroom
    </button>
  </div>

  <!-- Status Messages -->
  <div class="card mx-auto mb-4" style="max-width:800px;">
    <div class="card-body status-messages" id="statusMessages"></div>
  </div>

  <!-- Video Container -->
  <div class="video-container">
    <video id="localVideo" autoplay muted playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <!-- Whiteboard Section -->
  <div class="whiteboard-container">
    <canvas id="whiteboard" width="800" height="600"></canvas>
    <div class="toolbar text-center my-2">
      <button id="toggleEraser" class="btn btn-outline-secondary">Toggle Eraser</button>
      <button id="clearBoard" class="btn btn-outline-danger">Clear Board</button>
    </div>
  </div>

</div>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
  const socket = io({ reconnection: true });
  const startBtn = document.getElementById('startSessionBtn');

  function startSession() {
    startBtn.disabled = true;

    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        document.getElementById('localVideo').srcObject = stream;
        socket.emit('join', { room: "{{ roomName }}", user_id: {{ current_user_id }} });
      })
      .catch(err => alert('Camera/Microphone Error: ' + err));
  }

  startBtn.addEventListener('click', startSession);

  socket.on('connect', () => {
    document.getElementById('statusMessages').innerHTML += '<p>‚úÖ Connected to server</p>';
  });

  socket.on('signal', async (data) => {
    document.getElementById('statusMessages').innerHTML += '<p>Signal received: ' + data.type + '</p>';
  });

  // Auto-start on desktop
  if (window.innerWidth >= 768) startSession();
</script>

{% endblock %}
